  CategoryTable:
    Type: 'AWS::DynamoDB::Table'
    Properties:
      TableName: !Join
        - '-'
        - - Category
          - !GetAtt
            - GraphQLAPI
            - ApiId
      KeySchema:
        - AttributeName: id
          KeyType: HASH
      AttributeDefinitions:
        - AttributeName: id
          AttributeType: S
      ProvisionedThroughput:
        ReadCapacityUnits: !Ref DynamoDBModelTableReadIOPS
        WriteCapacityUnits: !Ref DynamoDBModelTableWriteIOPS
      StreamSpecification:
        StreamViewType: NEW_AND_OLD_IMAGES
  CategoryIAMRole:
    Type: 'AWS::IAM::Role'
    Properties:
      RoleName: !Join
        - '-'
        - - CategoryTable
          - role
          - !GetAtt
            - GraphQLAPI
            - ApiId
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: appsync.amazonaws.com
            Action: 'sts:AssumeRole'
      Policies:
        - PolicyName: DynamoDBAccess
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - 'dynamodb:BatchGetItem'
                  - 'dynamodb:BatchWriteItem'
                  - 'dynamodb:PutItem'
                  - 'dynamodb:DeleteItem'
                  - 'dynamodb:GetItem'
                  - 'dynamodb:Scan'
                  - 'dynamodb:Query'
                  - 'dynamodb:UpdateItem'
                Resource:
                  - !GetAtt
                    - CategoryTable
                    - Arn
                  - !Join
                    - /
                    - - !GetAtt
                        - CategoryTable
                        - Arn
                      - '*'
  CategoryDataSource:
    Type: 'AWS::AppSync::DataSource'
    Properties:
      ApiId: !GetAtt
        - GraphQLAPI
        - ApiId
      Name: CategoryTable
      Type: AMAZON_DYNAMODB
      ServiceRoleArn: !GetAtt
        - CategoryIAMRole
        - Arn
      DynamoDBConfig:
        AwsRegion: !Select
          - 3
          - !Split
            - ':'
            - !GetAtt
              - CategoryTable
              - Arn
        TableName: !Ref CategoryTable
    DependsOn: CategoryIAMRole
  GetCategoryResolver:
    Type: 'AWS::AppSync::Resolver'
    Properties:
      ApiId: !GetAtt
        - GraphQLAPI
        - ApiId
      DataSourceName: !GetAtt
        - CategoryDataSource
        - Name
      FieldName: getCategory
      TypeName: Query
      RequestMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - Query
                  - getCategory
                  - request
                  - !Ref DeploymentTimestamp
      ResponseMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - Query
                  - getCategory
                  - response
                  - !Ref DeploymentTimestamp
    DependsOn: GraphQLSchema
  ListCategoryResolver:
    Type: 'AWS::AppSync::Resolver'
    Properties:
      ApiId: !GetAtt
        - GraphQLAPI
        - ApiId
      DataSourceName: !GetAtt
        - CategoryDataSource
        - Name
      FieldName: listCategorys
      TypeName: Query
      RequestMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - Query
                  - listCategorys
                  - request
                  - !Ref DeploymentTimestamp
      ResponseMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - Query
                  - listCategorys
                  - response
                  - !Ref DeploymentTimestamp
    DependsOn: GraphQLSchema
  CreateCategoryResolver:
    Type: 'AWS::AppSync::Resolver'
    Properties:
      ApiId: !GetAtt
        - GraphQLAPI
        - ApiId
      DataSourceName: !GetAtt
        - CategoryDataSource
        - Name
      FieldName: createCategory
      TypeName: Mutation
      RequestMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - Mutation
                  - createCategory
                  - request
                  - !Ref DeploymentTimestamp
      ResponseMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - Mutation
                  - createCategory
                  - response
                  - !Ref DeploymentTimestamp
    DependsOn: GraphQLSchema
  UpdateCategoryResolver:
    Type: 'AWS::AppSync::Resolver'
    Properties:
      ApiId: !GetAtt
        - GraphQLAPI
        - ApiId
      DataSourceName: !GetAtt
        - CategoryDataSource
        - Name
      FieldName: updateCategory
      TypeName: Mutation
      RequestMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - Mutation
                  - updateCategory
                  - request
                  - !Ref DeploymentTimestamp
      ResponseMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - Mutation
                  - updateCategory
                  - response
                  - !Ref DeploymentTimestamp
    DependsOn: GraphQLSchema
  DeleteCategoryResolver:
    Type: 'AWS::AppSync::Resolver'
    Properties:
      ApiId: !GetAtt
        - GraphQLAPI
        - ApiId
      DataSourceName: !GetAtt
        - CategoryDataSource
        - Name
      FieldName: deleteCategory
      TypeName: Mutation
      RequestMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - Mutation
                  - deleteCategory
                  - request
                  - !Ref DeploymentTimestamp
      ResponseMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - Mutation
                  - deleteCategory
                  - response
                  - !Ref DeploymentTimestamp
    DependsOn: GraphQLSchema
  UserTable:
    Type: 'AWS::DynamoDB::Table'
    Properties:
      TableName: !Join
        - '-'
        - - User
          - !GetAtt
            - GraphQLAPI
            - ApiId
      KeySchema:
        - AttributeName: id
          KeyType: HASH
      AttributeDefinitions:
        - AttributeName: id
          AttributeType: S
        - AttributeName: tierId
          AttributeType: S
      ProvisionedThroughput:
        ReadCapacityUnits: !Ref DynamoDBModelTableReadIOPS
        WriteCapacityUnits: !Ref DynamoDBModelTableWriteIOPS
      StreamSpecification:
        StreamViewType: NEW_AND_OLD_IMAGES
      GlobalSecondaryIndexes:
        - IndexName: gsi-UserTier
          KeySchema:
            - AttributeName: tierId
              KeyType: HASH
          Projection:
            ProjectionType: ALL
          ProvisionedThroughput:
            ReadCapacityUnits: !Ref DynamoDBModelTableReadIOPS
            WriteCapacityUnits: !Ref DynamoDBModelTableWriteIOPS
  UserIAMRole:
    Type: 'AWS::IAM::Role'
    Properties:
      RoleName: !Join
        - '-'
        - - UserTable
          - role
          - !GetAtt
            - GraphQLAPI
            - ApiId
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: appsync.amazonaws.com
            Action: 'sts:AssumeRole'
      Policies:
        - PolicyName: DynamoDBAccess
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - 'dynamodb:BatchGetItem'
                  - 'dynamodb:BatchWriteItem'
                  - 'dynamodb:PutItem'
                  - 'dynamodb:DeleteItem'
                  - 'dynamodb:GetItem'
                  - 'dynamodb:Scan'
                  - 'dynamodb:Query'
                  - 'dynamodb:UpdateItem'
                Resource:
                  - !GetAtt
                    - UserTable
                    - Arn
                  - !Join
                    - /
                    - - !GetAtt
                        - UserTable
                        - Arn
                      - '*'
  UserDataSource:
    Type: 'AWS::AppSync::DataSource'
    Properties:
      ApiId: !GetAtt
        - GraphQLAPI
        - ApiId
      Name: UserTable
      Type: AMAZON_DYNAMODB
      ServiceRoleArn: !GetAtt
        - UserIAMRole
        - Arn
      DynamoDBConfig:
        AwsRegion: !Select
          - 3
          - !Split
            - ':'
            - !GetAtt
              - UserTable
              - Arn
        TableName: !Ref UserTable
    DependsOn: UserIAMRole
  GetUserResolver:
    Type: 'AWS::AppSync::Resolver'
    Properties:
      ApiId: !GetAtt
        - GraphQLAPI
        - ApiId
      DataSourceName: !GetAtt
        - UserDataSource
        - Name
      FieldName: getUser
      TypeName: Query
      RequestMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - Query
                  - getUser
                  - request
                  - !Ref DeploymentTimestamp
      ResponseMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - Query
                  - getUser
                  - response
                  - !Ref DeploymentTimestamp
    DependsOn: GraphQLSchema
  ListUserResolver:
    Type: 'AWS::AppSync::Resolver'
    Properties:
      ApiId: !GetAtt
        - GraphQLAPI
        - ApiId
      DataSourceName: !GetAtt
        - UserDataSource
        - Name
      FieldName: listUsers
      TypeName: Query
      RequestMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - Query
                  - listUsers
                  - request
                  - !Ref DeploymentTimestamp
      ResponseMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - Query
                  - listUsers
                  - response
                  - !Ref DeploymentTimestamp
    DependsOn: GraphQLSchema
  CreateUserResolver:
    Type: 'AWS::AppSync::Resolver'
    Properties:
      ApiId: !GetAtt
        - GraphQLAPI
        - ApiId
      DataSourceName: !GetAtt
        - UserDataSource
        - Name
      FieldName: createUser
      TypeName: Mutation
      RequestMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - Mutation
                  - createUser
                  - request
                  - !Ref DeploymentTimestamp
      ResponseMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - Mutation
                  - createUser
                  - response
                  - !Ref DeploymentTimestamp
    DependsOn: GraphQLSchema
  UpdateUserResolver:
    Type: 'AWS::AppSync::Resolver'
    Properties:
      ApiId: !GetAtt
        - GraphQLAPI
        - ApiId
      DataSourceName: !GetAtt
        - UserDataSource
        - Name
      FieldName: updateUser
      TypeName: Mutation
      RequestMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - Mutation
                  - updateUser
                  - request
                  - !Ref DeploymentTimestamp
      ResponseMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - Mutation
                  - updateUser
                  - response
                  - !Ref DeploymentTimestamp
    DependsOn: GraphQLSchema
  DeleteUserResolver:
    Type: 'AWS::AppSync::Resolver'
    Properties:
      ApiId: !GetAtt
        - GraphQLAPI
        - ApiId
      DataSourceName: !GetAtt
        - UserDataSource
        - Name
      FieldName: deleteUser
      TypeName: Mutation
      RequestMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - Mutation
                  - deleteUser
                  - request
                  - !Ref DeploymentTimestamp
      ResponseMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - Mutation
                  - deleteUser
                  - response
                  - !Ref DeploymentTimestamp
    DependsOn: GraphQLSchema
  CameraTable:
    Type: 'AWS::DynamoDB::Table'
    Properties:
      TableName: !Join
        - '-'
        - - Camera
          - !GetAtt
            - GraphQLAPI
            - ApiId
      KeySchema:
        - AttributeName: id
          KeyType: HASH
      AttributeDefinitions:
        - AttributeName: id
          AttributeType: S
        - AttributeName: userId
          AttributeType: S
      ProvisionedThroughput:
        ReadCapacityUnits: !Ref DynamoDBModelTableReadIOPS
        WriteCapacityUnits: !Ref DynamoDBModelTableWriteIOPS
      StreamSpecification:
        StreamViewType: NEW_AND_OLD_IMAGES
      GlobalSecondaryIndexes:
        - IndexName: gsi-UserCamera
          KeySchema:
            - AttributeName: userId
              KeyType: HASH
          Projection:
            ProjectionType: ALL
          ProvisionedThroughput:
            ReadCapacityUnits: !Ref DynamoDBModelTableReadIOPS
            WriteCapacityUnits: !Ref DynamoDBModelTableWriteIOPS
  CameraIAMRole:
    Type: 'AWS::IAM::Role'
    Properties:
      RoleName: !Join
        - '-'
        - - CameraTable
          - role
          - !GetAtt
            - GraphQLAPI
            - ApiId
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: appsync.amazonaws.com
            Action: 'sts:AssumeRole'
      Policies:
        - PolicyName: DynamoDBAccess
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - 'dynamodb:BatchGetItem'
                  - 'dynamodb:BatchWriteItem'
                  - 'dynamodb:PutItem'
                  - 'dynamodb:DeleteItem'
                  - 'dynamodb:GetItem'
                  - 'dynamodb:Scan'
                  - 'dynamodb:Query'
                  - 'dynamodb:UpdateItem'
                Resource:
                  - !GetAtt
                    - CameraTable
                    - Arn
                  - !Join
                    - /
                    - - !GetAtt
                        - CameraTable
                        - Arn
                      - '*'
  CameraDataSource:
    Type: 'AWS::AppSync::DataSource'
    Properties:
      ApiId: !GetAtt
        - GraphQLAPI
        - ApiId
      Name: CameraTable
      Type: AMAZON_DYNAMODB
      ServiceRoleArn: !GetAtt
        - CameraIAMRole
        - Arn
      DynamoDBConfig:
        AwsRegion: !Select
          - 3
          - !Split
            - ':'
            - !GetAtt
              - CameraTable
              - Arn
        TableName: !Ref CameraTable
    DependsOn: CameraIAMRole
  GetCameraResolver:
    Type: 'AWS::AppSync::Resolver'
    Properties:
      ApiId: !GetAtt
        - GraphQLAPI
        - ApiId
      DataSourceName: !GetAtt
        - CameraDataSource
        - Name
      FieldName: getCamera
      TypeName: Query
      RequestMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - Query
                  - getCamera
                  - request
                  - !Ref DeploymentTimestamp
      ResponseMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - Query
                  - getCamera
                  - response
                  - !Ref DeploymentTimestamp
    DependsOn: GraphQLSchema
  ListCameraResolver:
    Type: 'AWS::AppSync::Resolver'
    Properties:
      ApiId: !GetAtt
        - GraphQLAPI
        - ApiId
      DataSourceName: !GetAtt
        - CameraDataSource
        - Name
      FieldName: listCameras
      TypeName: Query
      RequestMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - Query
                  - listCameras
                  - request
                  - !Ref DeploymentTimestamp
      ResponseMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - Query
                  - listCameras
                  - response
                  - !Ref DeploymentTimestamp
    DependsOn: GraphQLSchema
  CreateCameraResolver:
    Type: 'AWS::AppSync::Resolver'
    Properties:
      ApiId: !GetAtt
        - GraphQLAPI
        - ApiId
      DataSourceName: !GetAtt
        - CameraDataSource
        - Name
      FieldName: createCamera
      TypeName: Mutation
      RequestMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - Mutation
                  - createCamera
                  - request
                  - !Ref DeploymentTimestamp
      ResponseMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - Mutation
                  - createCamera
                  - response
                  - !Ref DeploymentTimestamp
    DependsOn: GraphQLSchema
  UpdateCameraResolver:
    Type: 'AWS::AppSync::Resolver'
    Properties:
      ApiId: !GetAtt
        - GraphQLAPI
        - ApiId
      DataSourceName: !GetAtt
        - CameraDataSource
        - Name
      FieldName: updateCamera
      TypeName: Mutation
      RequestMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - Mutation
                  - updateCamera
                  - request
                  - !Ref DeploymentTimestamp
      ResponseMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - Mutation
                  - updateCamera
                  - response
                  - !Ref DeploymentTimestamp
    DependsOn: GraphQLSchema
  DeleteCameraResolver:
    Type: 'AWS::AppSync::Resolver'
    Properties:
      ApiId: !GetAtt
        - GraphQLAPI
        - ApiId
      DataSourceName: !GetAtt
        - CameraDataSource
        - Name
      FieldName: deleteCamera
      TypeName: Mutation
      RequestMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - Mutation
                  - deleteCamera
                  - request
                  - !Ref DeploymentTimestamp
      ResponseMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - Mutation
                  - deleteCamera
                  - response
                  - !Ref DeploymentTimestamp
    DependsOn: GraphQLSchema
  FaceTable:
    Type: 'AWS::DynamoDB::Table'
    Properties:
      TableName: !Join
        - '-'
        - - Face
          - !GetAtt
            - GraphQLAPI
            - ApiId
      KeySchema:
        - AttributeName: id
          KeyType: HASH
      AttributeDefinitions:
        - AttributeName: id
          AttributeType: S
        - AttributeName: categoryId
          AttributeType: S
        - AttributeName: userId
          AttributeType: S
      ProvisionedThroughput:
        ReadCapacityUnits: !Ref DynamoDBModelTableReadIOPS
        WriteCapacityUnits: !Ref DynamoDBModelTableWriteIOPS
      StreamSpecification:
        StreamViewType: NEW_AND_OLD_IMAGES
      GlobalSecondaryIndexes:
        - IndexName: gsi-FaceCategory
          KeySchema:
            - AttributeName: categoryId
              KeyType: HASH
          Projection:
            ProjectionType: ALL
          ProvisionedThroughput:
            ReadCapacityUnits: !Ref DynamoDBModelTableReadIOPS
            WriteCapacityUnits: !Ref DynamoDBModelTableWriteIOPS
        - IndexName: gsi-UserFace
          KeySchema:
            - AttributeName: userId
              KeyType: HASH
          Projection:
            ProjectionType: ALL
          ProvisionedThroughput:
            ReadCapacityUnits: !Ref DynamoDBModelTableReadIOPS
            WriteCapacityUnits: !Ref DynamoDBModelTableWriteIOPS
  FaceIAMRole:
    Type: 'AWS::IAM::Role'
    Properties:
      RoleName: !Join
        - '-'
        - - FaceTable
          - role
          - !GetAtt
            - GraphQLAPI
            - ApiId
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: appsync.amazonaws.com
            Action: 'sts:AssumeRole'
      Policies:
        - PolicyName: DynamoDBAccess
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - 'dynamodb:BatchGetItem'
                  - 'dynamodb:BatchWriteItem'
                  - 'dynamodb:PutItem'
                  - 'dynamodb:DeleteItem'
                  - 'dynamodb:GetItem'
                  - 'dynamodb:Scan'
                  - 'dynamodb:Query'
                  - 'dynamodb:UpdateItem'
                Resource:
                  - !GetAtt
                    - FaceTable
                    - Arn
                  - !Join
                    - /
                    - - !GetAtt
                        - FaceTable
                        - Arn
                      - '*'
  FaceDataSource:
    Type: 'AWS::AppSync::DataSource'
    Properties:
      ApiId: !GetAtt
        - GraphQLAPI
        - ApiId
      Name: FaceTable
      Type: AMAZON_DYNAMODB
      ServiceRoleArn: !GetAtt
        - FaceIAMRole
        - Arn
      DynamoDBConfig:
        AwsRegion: !Select
          - 3
          - !Split
            - ':'
            - !GetAtt
              - FaceTable
              - Arn
        TableName: !Ref FaceTable
    DependsOn: FaceIAMRole
  GetFaceResolver:
    Type: 'AWS::AppSync::Resolver'
    Properties:
      ApiId: !GetAtt
        - GraphQLAPI
        - ApiId
      DataSourceName: !GetAtt
        - FaceDataSource
        - Name
      FieldName: getFace
      TypeName: Query
      RequestMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - Query
                  - getFace
                  - request
                  - !Ref DeploymentTimestamp
      ResponseMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - Query
                  - getFace
                  - response
                  - !Ref DeploymentTimestamp
    DependsOn: GraphQLSchema
  ListFaceResolver:
    Type: 'AWS::AppSync::Resolver'
    Properties:
      ApiId: !GetAtt
        - GraphQLAPI
        - ApiId
      DataSourceName: !GetAtt
        - FaceDataSource
        - Name
      FieldName: listFaces
      TypeName: Query
      RequestMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - Query
                  - listFaces
                  - request
                  - !Ref DeploymentTimestamp
      ResponseMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - Query
                  - listFaces
                  - response
                  - !Ref DeploymentTimestamp
    DependsOn: GraphQLSchema
  CreateFaceResolver:
    Type: 'AWS::AppSync::Resolver'
    Properties:
      ApiId: !GetAtt
        - GraphQLAPI
        - ApiId
      DataSourceName: !GetAtt
        - FaceDataSource
        - Name
      FieldName: createFace
      TypeName: Mutation
      RequestMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - Mutation
                  - createFace
                  - request
                  - !Ref DeploymentTimestamp
      ResponseMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - Mutation
                  - createFace
                  - response
                  - !Ref DeploymentTimestamp
    DependsOn: GraphQLSchema
  UpdateFaceResolver:
    Type: 'AWS::AppSync::Resolver'
    Properties:
      ApiId: !GetAtt
        - GraphQLAPI
        - ApiId
      DataSourceName: !GetAtt
        - FaceDataSource
        - Name
      FieldName: updateFace
      TypeName: Mutation
      RequestMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - Mutation
                  - updateFace
                  - request
                  - !Ref DeploymentTimestamp
      ResponseMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - Mutation
                  - updateFace
                  - response
                  - !Ref DeploymentTimestamp
    DependsOn: GraphQLSchema
  DeleteFaceResolver:
    Type: 'AWS::AppSync::Resolver'
    Properties:
      ApiId: !GetAtt
        - GraphQLAPI
        - ApiId
      DataSourceName: !GetAtt
        - FaceDataSource
        - Name
      FieldName: deleteFace
      TypeName: Mutation
      RequestMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - Mutation
                  - deleteFace
                  - request
                  - !Ref DeploymentTimestamp
      ResponseMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - Mutation
                  - deleteFace
                  - response
                  - !Ref DeploymentTimestamp
    DependsOn: GraphQLSchema
  MotionTable:
    Type: 'AWS::DynamoDB::Table'
    Properties:
      TableName: !Join
        - '-'
        - - Motion
          - !GetAtt
            - GraphQLAPI
            - ApiId
      KeySchema:
        - AttributeName: id
          KeyType: HASH
      AttributeDefinitions:
        - AttributeName: id
          AttributeType: S
        - AttributeName: cameraId
          AttributeType: S
        - AttributeName: userId
          AttributeType: S
      ProvisionedThroughput:
        ReadCapacityUnits: !Ref DynamoDBModelTableReadIOPS
        WriteCapacityUnits: !Ref DynamoDBModelTableWriteIOPS
      StreamSpecification:
        StreamViewType: NEW_AND_OLD_IMAGES
      GlobalSecondaryIndexes:
        - IndexName: gsi-CameraMotion
          KeySchema:
            - AttributeName: cameraId
              KeyType: HASH
          Projection:
            ProjectionType: ALL
          ProvisionedThroughput:
            ReadCapacityUnits: !Ref DynamoDBModelTableReadIOPS
            WriteCapacityUnits: !Ref DynamoDBModelTableWriteIOPS
        - IndexName: gsi-UserMotion
          KeySchema:
            - AttributeName: userId
              KeyType: HASH
          Projection:
            ProjectionType: ALL
          ProvisionedThroughput:
            ReadCapacityUnits: !Ref DynamoDBModelTableReadIOPS
            WriteCapacityUnits: !Ref DynamoDBModelTableWriteIOPS
  MotionIAMRole:
    Type: 'AWS::IAM::Role'
    Properties:
      RoleName: !Join
        - '-'
        - - MotionTable
          - role
          - !GetAtt
            - GraphQLAPI
            - ApiId
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: appsync.amazonaws.com
            Action: 'sts:AssumeRole'
      Policies:
        - PolicyName: DynamoDBAccess
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - 'dynamodb:BatchGetItem'
                  - 'dynamodb:BatchWriteItem'
                  - 'dynamodb:PutItem'
                  - 'dynamodb:DeleteItem'
                  - 'dynamodb:GetItem'
                  - 'dynamodb:Scan'
                  - 'dynamodb:Query'
                  - 'dynamodb:UpdateItem'
                Resource:
                  - !GetAtt
                    - MotionTable
                    - Arn
                  - !Join
                    - /
                    - - !GetAtt
                        - MotionTable
                        - Arn
                      - '*'
  MotionDataSource:
    Type: 'AWS::AppSync::DataSource'
    Properties:
      ApiId: !GetAtt
        - GraphQLAPI
        - ApiId
      Name: MotionTable
      Type: AMAZON_DYNAMODB
      ServiceRoleArn: !GetAtt
        - MotionIAMRole
        - Arn
      DynamoDBConfig:
        AwsRegion: !Select
          - 3
          - !Split
            - ':'
            - !GetAtt
              - MotionTable
              - Arn
        TableName: !Ref MotionTable
    DependsOn: MotionIAMRole
  GetMotionResolver:
    Type: 'AWS::AppSync::Resolver'
    Properties:
      ApiId: !GetAtt
        - GraphQLAPI
        - ApiId
      DataSourceName: !GetAtt
        - MotionDataSource
        - Name
      FieldName: getMotion
      TypeName: Query
      RequestMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - Query
                  - getMotion
                  - request
                  - !Ref DeploymentTimestamp
      ResponseMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - Query
                  - getMotion
                  - response
                  - !Ref DeploymentTimestamp
    DependsOn: GraphQLSchema
  ListMotionResolver:
    Type: 'AWS::AppSync::Resolver'
    Properties:
      ApiId: !GetAtt
        - GraphQLAPI
        - ApiId
      DataSourceName: !GetAtt
        - MotionDataSource
        - Name
      FieldName: listMotions
      TypeName: Query
      RequestMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - Query
                  - listMotions
                  - request
                  - !Ref DeploymentTimestamp
      ResponseMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - Query
                  - listMotions
                  - response
                  - !Ref DeploymentTimestamp
    DependsOn: GraphQLSchema
  CreateMotionResolver:
    Type: 'AWS::AppSync::Resolver'
    Properties:
      ApiId: !GetAtt
        - GraphQLAPI
        - ApiId
      DataSourceName: !GetAtt
        - MotionDataSource
        - Name
      FieldName: createMotion
      TypeName: Mutation
      RequestMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - Mutation
                  - createMotion
                  - request
                  - !Ref DeploymentTimestamp
      ResponseMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - Mutation
                  - createMotion
                  - response
                  - !Ref DeploymentTimestamp
    DependsOn: GraphQLSchema
  UpdateMotionResolver:
    Type: 'AWS::AppSync::Resolver'
    Properties:
      ApiId: !GetAtt
        - GraphQLAPI
        - ApiId
      DataSourceName: !GetAtt
        - MotionDataSource
        - Name
      FieldName: updateMotion
      TypeName: Mutation
      RequestMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - Mutation
                  - updateMotion
                  - request
                  - !Ref DeploymentTimestamp
      ResponseMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - Mutation
                  - updateMotion
                  - response
                  - !Ref DeploymentTimestamp
    DependsOn: GraphQLSchema
  DeleteMotionResolver:
    Type: 'AWS::AppSync::Resolver'
    Properties:
      ApiId: !GetAtt
        - GraphQLAPI
        - ApiId
      DataSourceName: !GetAtt
        - MotionDataSource
        - Name
      FieldName: deleteMotion
      TypeName: Mutation
      RequestMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - Mutation
                  - deleteMotion
                  - request
                  - !Ref DeploymentTimestamp
      ResponseMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - Mutation
                  - deleteMotion
                  - response
                  - !Ref DeploymentTimestamp
    DependsOn: GraphQLSchema
  TierusersResolver:
    Type: 'AWS::AppSync::Resolver'
    Properties:
      ApiId: !GetAtt
        - GraphQLAPI
        - ApiId
      DataSourceName: !GetAtt
        - UserDataSource
        - Name
      FieldName: users
      TypeName: Tier
      RequestMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - Tier
                  - users
                  - request
                  - !Ref DeploymentTimestamp
      ResponseMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - Tier
                  - users
                  - response
                  - !Ref DeploymentTimestamp
    DependsOn: GraphQLSchema
  CategoryfacesResolver:
    Type: 'AWS::AppSync::Resolver'
    Properties:
      ApiId: !GetAtt
        - GraphQLAPI
        - ApiId
      DataSourceName: !GetAtt
        - FaceDataSource
        - Name
      FieldName: faces
      TypeName: Category
      RequestMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - Category
                  - faces
                  - request
                  - !Ref DeploymentTimestamp
      ResponseMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - Category
                  - faces
                  - response
                  - !Ref DeploymentTimestamp
    DependsOn: GraphQLSchema
  UsertierResolver:
    Type: 'AWS::AppSync::Resolver'
    Properties:
      ApiId: !GetAtt
        - GraphQLAPI
        - ApiId
      DataSourceName: !GetAtt
        - TierDataSource
        - Name
      FieldName: tier
      TypeName: User
      RequestMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - User
                  - tier
                  - request
                  - !Ref DeploymentTimestamp
      ResponseMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - User
                  - tier
                  - response
                  - !Ref DeploymentTimestamp
    DependsOn: GraphQLSchema
  UsercamerasResolver:
    Type: 'AWS::AppSync::Resolver'
    Properties:
      ApiId: !GetAtt
        - GraphQLAPI
        - ApiId
      DataSourceName: !GetAtt
        - CameraDataSource
        - Name
      FieldName: cameras
      TypeName: User
      RequestMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - User
                  - cameras
                  - request
                  - !Ref DeploymentTimestamp
      ResponseMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - User
                  - cameras
                  - response
                  - !Ref DeploymentTimestamp
    DependsOn: GraphQLSchema
  UsermotionsResolver:
    Type: 'AWS::AppSync::Resolver'
    Properties:
      ApiId: !GetAtt
        - GraphQLAPI
        - ApiId
      DataSourceName: !GetAtt
        - MotionDataSource
        - Name
      FieldName: motions
      TypeName: User
      RequestMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - User
                  - motions
                  - request
                  - !Ref DeploymentTimestamp
      ResponseMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - User
                  - motions
                  - response
                  - !Ref DeploymentTimestamp
    DependsOn: GraphQLSchema
  UserfacesResolver:
    Type: 'AWS::AppSync::Resolver'
    Properties:
      ApiId: !GetAtt
        - GraphQLAPI
        - ApiId
      DataSourceName: !GetAtt
        - FaceDataSource
        - Name
      FieldName: faces
      TypeName: User
      RequestMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - User
                  - faces
                  - request
                  - !Ref DeploymentTimestamp
      ResponseMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - User
                  - faces
                  - response
                  - !Ref DeploymentTimestamp
    DependsOn: GraphQLSchema
  CamerauserResolver:
    Type: 'AWS::AppSync::Resolver'
    Properties:
      ApiId: !GetAtt
        - GraphQLAPI
        - ApiId
      DataSourceName: !GetAtt
        - UserDataSource
        - Name
      FieldName: user
      TypeName: Camera
      RequestMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - Camera
                  - user
                  - request
                  - !Ref DeploymentTimestamp
      ResponseMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - Camera
                  - user
                  - response
                  - !Ref DeploymentTimestamp
    DependsOn: GraphQLSchema
  CameramotionsResolver:
    Type: 'AWS::AppSync::Resolver'
    Properties:
      ApiId: !GetAtt
        - GraphQLAPI
        - ApiId
      DataSourceName: !GetAtt
        - MotionDataSource
        - Name
      FieldName: motions
      TypeName: Camera
      RequestMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - Camera
                  - motions
                  - request
                  - !Ref DeploymentTimestamp
      ResponseMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - Camera
                  - motions
                  - response
                  - !Ref DeploymentTimestamp
    DependsOn: GraphQLSchema
  FacecategoryResolver:
    Type: 'AWS::AppSync::Resolver'
    Properties:
      ApiId: !GetAtt
        - GraphQLAPI
        - ApiId
      DataSourceName: !GetAtt
        - CategoryDataSource
        - Name
      FieldName: category
      TypeName: Face
      RequestMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - Face
                  - category
                  - request
                  - !Ref DeploymentTimestamp
      ResponseMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - Face
                  - category
                  - response
                  - !Ref DeploymentTimestamp
    DependsOn: GraphQLSchema
  FaceuserResolver:
    Type: 'AWS::AppSync::Resolver'
    Properties:
      ApiId: !GetAtt
        - GraphQLAPI
        - ApiId
      DataSourceName: !GetAtt
        - UserDataSource
        - Name
      FieldName: user
      TypeName: Face
      RequestMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - Face
                  - user
                  - request
                  - !Ref DeploymentTimestamp
      ResponseMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - Face
                  - user
                  - response
                  - !Ref DeploymentTimestamp
    DependsOn: GraphQLSchema
  MotioncameraResolver:
    Type: 'AWS::AppSync::Resolver'
    Properties:
      ApiId: !GetAtt
        - GraphQLAPI
        - ApiId
      DataSourceName: !GetAtt
        - CameraDataSource
        - Name
      FieldName: camera
      TypeName: Motion
      RequestMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - Motion
                  - camera
                  - request
                  - !Ref DeploymentTimestamp
      ResponseMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - Motion
                  - camera
                  - response
                  - !Ref DeploymentTimestamp
    DependsOn: GraphQLSchema
  MotionuserResolver:
    Type: 'AWS::AppSync::Resolver'
    Properties:
      ApiId: !GetAtt
        - GraphQLAPI
        - ApiId
      DataSourceName: !GetAtt
        - UserDataSource
        - Name
      FieldName: user
      TypeName: Motion
      RequestMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - Motion
                  - user
                  - request
                  - !Ref DeploymentTimestamp
      ResponseMappingTemplateS3Location: !Join
        - ''
        - - 's3://'
          - !Join
            - /
            - - !Ref ResolverBucket
              - !Ref ResolverRootKey
              - !Join
                - .
                - - Motion
                  - user
                  - response
                  - !Ref DeploymentTimestamp
    DependsOn: GraphQLSchema
